name: Build iOS 8-10 32-bit (No ARC Hack)

on: [push, pull_request]

jobs:
  build:
    runs-on: macos-14  # ใช้ default Xcode 16.2 – ไม่ต้อง switch
    steps:
      - uses: actions/checkout@v4

      - name: Install ldid + ct_bypass
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          brew install ldid
          curl -L -o ~/ct_bypass https://github.com/opa334/ChOma/releases/download/0.3/ct_bypass-macos || curl -L -o ~/ct_bypass https://github.com/haxi0/ChOma/releases/download/0.3/ct_bypass
          chmod +x ~/ct_bypass
          ~/ct_bypass --help || echo "ct_bypass ready"

      - name: Build 32-bit iOS 8 (disable ARC to fix libarclite)
        run: |
          make clean
          make ARCHS=armv7 MIN_IOS_VERSION=8.0 NO_ARC=1  # ส่ง NO_ARC=1 เพื่อปิด ARC
          file pseudo_unsigned  # เช็คว่า armv7 จริงมั้ย (Mach-O executable arm_v7)
          ls -la pseudo*

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: pseudo-ios8-armv7-noarc
          path: pseudo*
          retention-days: 30
